# Общие требования

Система представляет собой рекламный сервер, предоставляющия API для:
1. получение рекламного блока;
2. добавлении/удалении рекламных компаний;
3. регистрация, аутентификация и авторизация пользователей;

## Сводное HTTP API:
- `GET /` - запрос рекламного блока
- `GET /advert?status` - получение списка рекламных компаний (только для авторизированных пользователей)
- `POST /advert` - регистрация рекламной компании (только для авторизированных пользователей)
- `DELETE /advert/{id}` - отключение рекламной компании (только для авторизированных пользователей)
- `POST /login` - аутентификация в системе
- `POST /register` - регистрация в системе

## Основной флоу рекламадателя
1. Регистрируемся
2. Авторизуемся
3. Используя ключ авторизации из п.2 создаём рекламную компанию
3. Где-то у себя разворачиваем сервис creative или покупаем наши мощности
4. Получаем наплыв пользователей и радуемся

## Основной флоу посетителя
1. приходим на GET / к adserver
2. получаем 200 или 307 с Location хедером
3. отображаем пустую страницу или страницу с рекламой, которую мы получим если пройдём по Location хедеру

## Внутренняя структура проекта

### adserver
На каждый запрос по выдаче рекламного блока:
1. в БД получает список creative серверов
2. проходится по всем creative серверам учитывая {CREATIVE_BACKEND_TIMEOUT}
3. если никто не ответил, то 200 с пустой страницей и заканчивает работу
4. выбирает самый высокий по price среди ответов
5. в БД вычитает price у budget creative сервера
6. в БД забирает location по creative серверу
7. возвращает 307 посетителю

### site
Работа с рекламодателями
1. Регистрирует и авторизирует рекламодателей
2. Добавляет и выключает рекламные кампании

## Сервис adserver

### Хендлеры adserver
`GET /` - запрос рекламного блока на сайт

Коды ответов:
- 200 и пустая страница (если рекламный блок для показа не найден)
- 307 и Location header cо страницей редиректом на сайт рекламодателя

### Переменные окружения и параметры запуска
- ENV `SERVER_ADDRESS` или CLI `--server-address` - параметр, указывающий какой host и port используется для организации сервера. ":8080" по умолчанию
- ENV `CREATIVE_BACKEND_TIMEOUT` или CLI `--creative-backend-timeout` - параметр, указывающий сколько времени ждать ответа от creative серверов. "500ms" по умолчанию

## Сервис site
### Хендлеры сервиса site
`GET /advert?status=active` - запрос получение списка рекламных компаний пользователя с опциональным параметром status

Коды ответов:
- 200 и ответ Content-type: application/json следующей структуры: [{"id":0,"creative_url":"http://creative.server.url/example","budget":10000},{"id":2,"creative_url":"http://creative.server2.url/example","budget":1000}]
- 401 при отсутствии или некорректном токене в header Authorization

`POST /advert` - регистрация рекламной компании. Требует наличия токена авторизация. Принимает на вход Content-type: application/json следующей структуры: {"creative_url":"http://creative.server.url/example","budget":10000}

Коды ответов:
- 200 ответ Content-type: application/json следующей структуры: {"id":10}
- 400 неверный формат запроса
- 401 при отсутствии или некорректном токене в header Authorization

`DELETE /advert/{id}` - отключение рекламной компании. Требует наличия токена авторизации и идентификатора рекламной кампании

Коды ответов:
- 200 при успешном удалении
- 401 при отсутствии или некорректном токене в header Authorization
- 404 при повторном удалении или когда {id} рекламной компании нет за данным пользователем

`POST /login` - авторизация пользователей. Принимает на вход Content-type: application/json следующей структуры: {"login":"mylogin","password":"mypasswd"}

Коды ответов:
- 200 ответ с header Authorization
- 400 неверный формат запроса

`POST /registration` - endpoint регистрации пользователей. Принимает на вход Content-type: application/json следующей структуры: {"login":"mylogin","password":"mypasswd"}

Коды ответов:
- 200 успешная регистрация
- 400 неверный формат запроса
- 409 логин занят

## Сервис creative (поставляется в качестве примера)

### Хендлеры creative
`GET /`

Коды ответов:
- 200 - ответ Content-type: application/json следующей структуры:{"price":231}
- 204 - данный клиент не интересен

### Переменные окружения и параметры запуска
- ENV `SERVER_ADDRESS` или CLI `-a` - параметр, указывающий какой host и port используется для организации сервера. ":8080" по умолчанию
- ENV `RESPONSE_WINDOW` или CLI `-r` - параметр в ms, указывающий окно sleep time для ответа для имитации бурной деятельности по оценке параметров запроса. "1000" по умолчанию
- ENV `PRICE_WINDOW` или CLI `-p` - параметр, рандомизирующий price ( ответ от 0 до этого верхнего предела) для имитации бурной деятельности по оценке параметров запроса. "1000" по умолчанию

## TODOs
1. для adserver ENV `CLUSTER_ENDPOINTS` или CLI `--cluster-endpoints` - параметр, содержащий список хостов/IP адресов, перечесленных через запятую (или точку с запятой) других серверов adserver текущей инсталяции. Переменная учитывается только при инициализации. Не рекомендуется поднимать кластер с разными значениями этой переменной, т.к. топология вместо целевой (все со всеми) может поменяться на подобие звезды, в связи с чем возможна как частичная так и полная рассинхронизация данных. "" по умолчанию. Собирает adserver'а в кластер для горизонтального масштабирования
2. Можно добавить параметр с идентификатором сайта источника для сервиса adserver, чтобы оформить функционал вознаграждения для сайта источника, если мы отображаем рекламу, например, не свою (как вкактакте к примеру), а организуем полноценный сервис по матчингу сайтов с рекламными блоками и клиентов, которым нужен большой охват. Разбор referer header не является лучшим решением, т.к. различные расширения приватности браузеров его очищают. Плюс разбор referer потребует больше тактов процессора и на стороне adserver и на стороне БД, т.к. с пользователей придётся либо требовать перечисления всех возможных referer и/или проверять, что они уникальные во всей системе. Дополнительно нужен будет функционал в site для работы с клиентами
3. Можно добавить параметры ширины/высоты при запросе на adserver, разбор header Accept-Language , User-Agent, IP посетителя и т.д., которые будут пробрасываться дальше до creative сервисов, чтобы они могли лучше таргетировать компании
4. Можно (и это правильно) выгружать в сам adserver соответствия активных рекламных компаний и URL для редиректа периодически, чтобы снизить прямую нагрузку на БД. Это где-то по максимум 100-300 байт на каждую. Для highload это потребуется точно
5. Можно (и это правильно) отвязать траты фиксируемые в adserver от realtime запросов, которые он обрабатывает. Во первых нам не страшно, если с лагом в несколько секунд/минут закончится рекламная компания, пока мы будем удалять её из кешей adserver. Читаем логи запросов из какого-нибудь clickhouse -> делаем минусы рекламным компаниям в БД, скажем раз в 1-10 мин -> те, что ушли в минус удаляем из кеша adserver через подключение к тем же adserver к их CLUSTER_ENDPOINTS
6. Можно добавить в рекламные компании предварительные фильтры, например по языку или страны посетителя, чтобы снизить кол-во возможных подключений к creative серверам и снизить на них же нагрузку, переложив нагрузку у adserver с сетевого (трафик и подключения) уровня на CPU, т.к. это дешевле